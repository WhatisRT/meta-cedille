b-let stringListToList (l : init$stringList) : List init$string :=
  l ?(List init$string) (nil ?init$string)
    (λ s : init$string. λ rec : List init$string. cons ?init$string s rec).

b-let listToStringList (l : List init$string) : init$stringList :=
  (inductionList ?init$string ?(λ _ : List init$string. init$stringList)
                 init$stringList$nil
                 (λ s : init$string. λ _ : List init$string. λ rec : init$stringList. init$stringList$cons s rec))
    l.

b-let namePrefixChar (c : init$char) (n : init$name) : init$name :=
  n ?init$name (λ c' : init$char. λ n' : init$name'. quote$name c (quote$ncons c' n')).

b-let namePrefix (s : init$string) (n : init$name) : init$name :=
  s ?init$name (λ c : init$char. λ rec : init$name. namePrefixChar c rec) n.

b-let termListToList (l : init$termList) : List init$term :=
  l ?(List init$term) (nil ?init$term)
    (λ s : init$term. λ rec : List init$term. cons ?init$term s rec).

b-let metaResult : * := Product (List init$string) (List init$term).

b-let strToMetaResult (s : init$string) : metaResult :=
  pair ?(List init$string) ?(λ _ : List init$string. List init$term) [init$string | s] [init$term |].

b-let metaResultToLists (res : init$metaResult) : metaResult :=
  res ?metaResult
    (λ l : init$stringList. λ l' : init$termList.
      prodPair ?(List init$string) ?(List init$term) (stringListToList l) (termListToList l')).

b-let eval' (stmt : init$stmt) : M metaResult :=
  mapMeta ?init$metaResult ?metaResult metaResultToLists (eval stmt).

b-let echoCommand (s : init$string) : M metaResult :=
  mapMeta ?init$string ?metaResult strToMetaResult (shellCmd "echo" (listToStringList [init$string | s])).

b-let simpleCommand (s : init$string) : M metaResult :=
  mapMeta ?init$string ?metaResult strToMetaResult (shellCmd s (listToStringList [init$string |])).

b-let letInfoTermToQuoted (i : LetInfo) : LetInfo :=
  mkLetInfo (namePrefix "qTerm" (letInfoName i)) (quoteTerm (letInfoTerm i)) (just' ?init$term θ{init$term}).

b-let init$newStmt : * := M metaResult.

b-let runMetaCommand (t : init$term) : init$newStmt :=
  joinMeta ?metaResult (checkTerm (M metaResult) t).

b-let seqNewStmt (s, s' : init$newStmt) := bindMeta ?metaResult ?metaResult s (λ _ : metaResult. s').

b-let stmtToNewStmt (stmt : init$stmt') : init$newStmt :=
  eval' (quote$stmt'ToStmt stmt).

b-let letInfoToNewStmt (i : LetInfo) : init$newStmt := stmtToNewStmt (convertLetInfo i).

-- statements from the old syntax
b-let init$newStmt'$o=minus=_stmt'_ (stmt : init$stmt') : init$newStmt := stmtToNewStmt stmt.

-- "native" statements in the new syntax
b-let init$newStmt'$let_space__betterLet_ (_ : init$space) (i : LetInfo) : init$newStmt := letInfoToNewStmt i .
b-let init$newStmt'$qlet_space__betterLet_ (_ : init$space) (i : LetInfo) : init$newStmt :=
  seqNewStmt (letInfoToNewStmt i) (letInfoToNewStmt (letInfoTermToQuoted i)).
b-let init$newStmt'$runMeta_space__multiTerm_=dot= (_ : init$space) (t : init$term) : init$newStmt := runMetaCommand t.
b-let init$newStmt'$echo_space__multiTerm_=dot= (_ : init$space) (t : init$term) : init$newStmt :=
  runMetaCommand (quote$square θ{echoCommand} t).
b-let init$newStmt'$import_space__name_=dot= (_ : init$space) (n : init$name) : init$newStmt := stmtToNewStmt (quote$import' n).
b-let init$newStmt'$ : init$newStmt := stmtToNewStmt init$stmt'$.

b-let init$newStmt$_space'__newStmt'_ (_ : init$space') (stmt : init$newStmt) : init$newStmt := stmt.

-- new evaluator
b-let evalNewStmt (stmt : init$newStmt) : M metaResult := stmt.

seteval evalNewStmt init newStmt.